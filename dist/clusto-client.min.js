"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),hyperquest=require("hyperquest"),URI=require("URIjs"),Promise=require("bluebird"),querystring=require("querystring"),Applications={ATTRIBUTE:"clustoapi.apps.attribute",ENTITY:"clustoapi.apps.entity",RESOURCE_MANAGER:"clustoapi.apps.resourcemanager"};exports.Applications=Applications;var Mode={COMPACT:"compact",EXPANDED:"expanded"};exports.Mode=Mode;var Headers={MODE:"Clusto-Mode",PER_PAGE:"Clusto-Per-Page",PAGE:"Clusto-Page",PAGES:"Clusto-Pages",MINIFY:"Clusto-Minify"};exports.Headers=Headers;var AttributeType={INTEGER:"int",STRING:"string",DATETIME:"datetime",RELATION:"relation",JSON:"json"};exports.AttributeType=AttributeType;var Client=function(){function a(b){_classCallCheck(this,a),this.mount_points=new Map,this._base_url=new URI("http://localhost:9664"),this.attribute={__proto__:this,app:Applications.ATTRIBUTE,get:function(a){var b=new URI;return"string"==typeof a?b.segment(a):(b.segment(a.name),a.key&&b.segment(a.key),a.subkey&&b.segment(a.subkey),a.number&&b.segment(a.number)),this._get(b.toString(),{app:this.app})},add:function(a){var b="/"+a.name,c={app:this.app,mode:a.mode,params:{key:a.key,value:a.value}};return a.subkey&&(c.params.subkey=a.subkey),a.number&&(c.params.number=a.number),this._post(b,c)},set:function(a){var b=(new URI).segment(a.name).segment(a.key);a.subkey&&b.segment(a.subkey),a.number&&b.segment(a.number);var c={app:this.app,mode:a.mode,params:{value:a.value}};return this._put(b,c)},"delete":function(a){var b=(new URI).segment(a.name).segment(a.key);return a.subkey&&b.segment(a.subkey),a.number&&b.segment(a.number),this._delete(b.toString(),{app:this.app})}},this.entity={__proto__:this,app:Applications.ENTITY,get:function(a){var b=new URI,c="string"==typeof a?{driver:a}:a||{};return c.driver&&b.segment(c.driver),c.name&&b.segment(c.name),this._get(b.toString(),{app:this.app,mode:c.mode})},create:function(a){var b="/"+a.driver;return this._post(b,{mode:a.mode,app:this.app,params:{name:a.name}})},insert:function(a){var b="/"+a.driver+"/"+a.name;return this._post(b,{mode:a.mode,app:this.app,params:{device:a.device,action:"insert"}})},remove:function(a){var b="/"+a.driver+"/"+a.name;return this._post(b,{mode:a.mode,app:this.app,params:{device:a.device,action:"remove"}})},"delete":function(a){var b=(new URI).segment(a.driver).segment(a.name);return this._delete(b.toString(),{app:this.app})}},this.resource={__proto__:this,app:Applications.RESOURCE_MANAGER,get:function(a){var b=new URI,c="string"==typeof a?{driver:a}:a||{};return c.driver&&b.segment(c.driver),c.manager&&b.segment(c.manager),this._get(b.toString(),{app:this.app,mode:c.mode})},create:function(a){var b="/"+a.driver,c={app:this.app,mode:a.mode,params:{name:a.name}};if(a.params){var d=!0,e=!1,f=void 0;try{for(var g,h=Object.keys(a.params)[Symbol.iterator]();!(d=(g=h.next()).done);d=!0){var i=g.value;c.params[i]=a.params[i]}}catch(j){e=!0,f=j}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}}return this._post(b,c)},allocate:function(a){var b="/"+a.driver+"/"+a.manager,c=(a.driver||a.object,{app:this.app,mode:a.mode,params:{}});return a.object&&(c.params.object=a.object),a.resource&&(c.params.resource=a.resource),this._post(b,c)},deallocate:function(a){var b=(new URI).segment(a.driver).segment(a.manager);return this._delete(b.toString(),{app:this.app})}},b&&("string"==typeof b?this._base_url=new URI(b):b.base_url&&(this._base_url=new URI(b.base_url)))}return _createClass(a,[{key:"base_url",get:function(){return this._base_url.clone()}},{key:"init",value:function(){var a=this;return this.get_meta().then(function(b){a.mount_points.clear();var c=!0,d=!1,e=void 0;try{for(var f,g=Object.keys(b)[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var h=f.value,i=b[h];a.mount_points.set(i,h)}}catch(j){d=!0,e=j}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}})}},{key:"get_version",value:function(){return this._get("/__version__")}},{key:"get_meta",value:function(){return this._get("/__meta__")}},{key:"get_doc",value:function(){return this._get("/__doc__")}},{key:"get_driverlist",value:function(){return this._get("/driverlist")}},{key:"get_from_pools",value:function(a){var b={params:{}};return"string"==typeof a?b.params.pool=a:(b.params.pool=a.pool,b.params.driver=a.driver,b.params.children=a.children,b.mode=a.mode),this._get("/from-pools",b)}},{key:"get_by_name",value:function(a){var b={params:{}},c=null;return"string"==typeof a?c=a:(c=a.name,a.mode&&(b.mode=a.mode),a.driver&&(b.params.driver=a.driver)),this._get("/by-name/"+c,b)}},{key:"get_by_names",value:function(a){var b={params:{}};if(a instanceof Array)b.params.name=a;else{var c=a;b.params.name=c.names,c.mode&&(b.mode=c.mode)}return this._get("/by-names",b)}},{key:"get_by_attr",value:function(a){var b={params:{}};return"string"==typeof a?b.params.key=a:(b.params.key=a.key,a.subkey&&(b.params.subkey=a.subkey),a.value&&(b.params.value=a.value)),this._get("/by-attr",b)}},{key:"_get",value:function(a,b){return this._request("GET",a,b)}},{key:"_delete",value:function(a,b){return this._request("DELETE",a,b)}},{key:"_post",value:function(a,b){return this._request("POST",a,b)}},{key:"_put",value:function(a,b){return this._request("PUT",a,b)}},{key:"_request",value:function(a,b,c){var d=this.base_url;c&&c.app&&d.segment(this.mount_points.get(c.app)),d.segment(b).normalizePath();var e={"Clusto-Minify":!0,Accept:"application/json"};c&&c.mode&&(e[Headers.MODE]=c.mode),c&&c.page&&(e[Headers.PAGE]=c.page),c&&c.per_page&&(e[Headers.PER_PAGE]=c.per_page),"GET"===a&&c&&c.params&&d.setSearch(c.params),console.log(""+a+" "+d.toString());var f=hyperquest({method:a,uri:d.toString(),headers:e});return("POST"===a||"PUT"===a)&&c&&c.params&&f.end(querystring.stringify(c.params)),new Promise(function(a,b){var c="";f.on("data",function(a){c+=a.toString()}).on("end",function(){try{var d=JSON.parse(c);a(d)}catch(e){b(c)}}).on("error",function(a){b(a)})})}}]),a}();exports.Client=Client;
//# sourceMappingURL=clusto-client.min.js.map